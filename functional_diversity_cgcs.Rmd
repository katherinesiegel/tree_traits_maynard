---
title: "functional_diversity_cgcs"
output: html_document
date: "2024-07-21"
---

### resources for calculations
https://cran.r-project.org/web/packages/fundiversity/vignettes/fundiversity.html 
# does not work for n > 16 traits

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

### Load packages
library(tidyverse)
library(sf)
library(FD)
library(data.table)
install.packages("fundiversity")

data(package = "fundiversity")
```


### prep time data
```{r}
### number of time-period observations per plot
install.packages("lubridate")

wcan_biomass_total <- read.csv("our_data/biomass_materials/wcan_biomass_total.csv")

trait_summ <- wcan_biomass_total %>%
  group_by(nfi_plot) %>%
  summarise(n_surveyed = length(unique(meas_date)))
table(trait_summ$n_surveyed)
# 17 surveyed once, 378 surveyed twice, 36 surveyed three times

### drop plots surveyed once
once <- c("1100981", "1114666", "1128941","1162841","1218396","1225241","1232216", "1273466", "1279961", "1294161", "1328041", "1335371", "1410761", "1424456", "1445166", "1452066")

wcan_dat <- wcan_biomass_total %>%
  filter(!nfi_plot %in% once)

### simplify data
wcan_dat_simp <- wcan_dat %>%
  dplyr::select(nfi_plot,
                meas_date,
                NFI_species,
                biomass_composition) %>%
  group_by(nfi_plot,
           meas_date,
           NFI_species,
           biomass_composition)
                

### add survey numbers to data
wcan_dat <- merge(wcan_dat_simp,
                  trait_summ,
                  by = "nfi_plot")

### change meas_date to ymd form
library("lubridate")

wcan_dat$meas_date <- ymd(wcan_dat$meas_date)

### set t(min) and t(max)
trait_t <- wcan_dat %>%
  group_by(nfi_plot) %>%
  summarise(min_year = min(meas_date),
            max_year = max(meas_date))

### merge with wcan_dat
wcan_dat <- merge(wcan_dat,
                  trait_t,
                  by = "nfi_plot")

### add time steps
wcan_dat <- wcan_dat %>%
  mutate(time_step = ifelse(meas_date ==min_year, "t1",
                            ifelse(meas_date == max_year & n_surveyed == 2, "t2",
                                   ifelse(meas_date == max_year & n_surveyed == 3, "t3", 
                                          "t2"))))
wcan_dat <- wcan_dat %>%
  mutate(meas_year = year(ymd(wcan_dat$meas_date)))

write.csv(wcan_dat, "wcan_dat.csv")

### df of time step and plots
wcan_time_step <- wcan_dat %>%
  dplyr::select(nfi_plot, meas_date, time_step, meas_year) %>%
  distinct()
write.csv(wcan_time_step, "wcan_time_step.csv")
```

### t1 plots
```{r}
### make df for t1 plots
wcan_t1 <- wcan_dat %>%
  filter(time_step == "t1")

wcan_t1 <- wcan_t1 %>%
  dplyr::select(nfi_plot,
                meas_date,
                NFI_species,
                time_step,
                biomass_composition,
                meas_year)

### total biomass per plot
plot_biomass_tot <- wcan_t1 %>%
  group_by(nfi_plot, meas_date) %>%
  summarise(total_biomass_plot = sum(biomass_composition))

### merge 
wcan_t1 <- merge(wcan_t1, plot_biomass_tot,
                 by = c("nfi_plot", "meas_date"))

### percent biomass (per plot)
wcan_t1 <- wcan_t1 %>%
  mutate(pct_biomass = biomass_composition/total_biomass_plot)

### save as csv
write.csv(wcan_t1, "wcan_t1.csv")
```

### reformat traits
```{r}
### open nfi traits file
trait_dat_clean_sp <- read.csv("C:/Users/krist/Downloads/nfi_trait_dat_clean_sp.csv")

### select necessary columns
trait_dat <- trait_dat_clean_sp %>%
  dplyr::select(vect_sp_codes, try_species_id,
                trait_name, try_trait_id,
                value
                )
unique(trait_dat$trait_name)

### make dispersal syndrome numeric
dispersal <- filter(trait_dat, trait_name == "dispersal syndrome") 
unique(dispersal$value) # lists unique dispersal syndrome methods

trait_dat$value[trait_dat$value == "animals, general"] <- 2
trait_dat$value[trait_dat$value == "birds"] <- 2
trait_dat$value[trait_dat$value == "mammals"] <- 2
trait_dat$value[trait_dat$value == "human"] <- 2
trait_dat$value[trait_dat$value == "water"] <- 3
trait_dat$value[trait_dat$value == "wind and water"] <- 4
trait_dat$value[trait_dat$value == "wind"] <- 6

### make leaf texture (coarseness) numeric
trait_dat$value[trait_dat$value == "fine"] <- 1
trait_dat$value[trait_dat$value == "medium"] <- 2
trait_dat$value[trait_dat$value == "coarse"] <- 3

### make Leaf texture (sclerophylly, physical strength, toughness) numeric
trait_dat$value[trait_dat$value == "always mesomorphic"] <- 1

### make foliage type (deciduous or evergreen) numeric
trait_dat$value[trait_dat$value == "evergreen"] <- 4
trait_dat$value[trait_dat$value == "evergreen but drought deciduous"] <- 3
trait_dat$value[trait_dat$value == "semi-evergreen"] <- 2
trait_dat$value[trait_dat$value == "deciduous"] <- 1

### make coarse root rooting depth numeric
trait_dat$value[trait_dat$value == "shallow"] <- 1
trait_dat$value[trait_dat$value == "shallow_moderate"] <- 2
trait_dat$value[trait_dat$value == "varying"] <- 3
trait_dat$value[trait_dat$value == "deep"] <- 4

### make clonal growth numeric
trait_dat$value[trait_dat$value == "underground"] <- 4
trait_dat$value[trait_dat$value == "basal"] <- 3
trait_dat$value[trait_dat$value == "abovegound"] <- 2
trait_dat$value[trait_dat$value == "none"] <- 1

### make cone serotiny numeric
trait_dat$value[trait_dat$value == "non-serotinous"] <- 1
trait_dat$value[trait_dat$value == "variable"] <- 2
trait_dat$value[trait_dat$value == "serotinous and semi-serotinous"] <- 3
trait_dat$value[trait_dat$value == "serotinous"] <- 4

### make clonal growth form numeric
trait_dat$value[trait_dat$value =="roots with adventitious buds"] <- 1
trait_dat$value[trait_dat$value == "root suckers"] <- 3
trait_dat$value[trait_dat$value == "root crown, root suckers"] <- 2
trait_dat$value[trait_dat$value == "root crown"] <- 2
trait_dat$value[trait_dat$value == "layering, rooting of fallen branches, fallen trunks"] <- 4
trait_dat$value[trait_dat$value == "layering, root collar"] <- 4
trait_dat$value[trait_dat$value == "layering, branches, stems"] <- 4
trait_dat$value[trait_dat$value == "layering"] <- 4
trait_dat$value[trait_dat$value == "epicormic shoots (coppice shoots)"] <- 5
trait_dat$value[trait_dat$value == "basal sprouts"] <- 3

### make degress of self-pruning numeric
trait_dat$value[trait_dat$value == "moderate"] <- 1
trait_dat$value[trait_dat$value == "high"] <- 2

### make fire_tolerance numeric
trait_dat$value[trait_dat$value == "low"] <- 1
trait_dat$value[trait_dat$value == "moderate"] <- 2
trait_dat$value[trait_dat$value == "high"] <- 3

### make leaf flammability numeric
trait_dat$value[trait_dat$value == "low"] <- 1
trait_dat$value[trait_dat$value == "moderate"] <- 2
trait_dat$value[trait_dat$value == "high"] <- 3

### make seed bank longevity numeric
trait_dat$value[trait_dat$value == "0.25-1"] <- 1
trait_dat$value[trait_dat$value == "< 1"] <- 1
trait_dat$value[trait_dat$value == "1-5"] <- 2
trait_dat$value[trait_dat$value == "3-5"] <- 3
trait_dat$value[trait_dat$value == ">5"] <- 4

trait_dat$value <- as.numeric(trait_dat$value)

write.csv(trait_dat, "trait_dat_num.csv")

### collect the mean values of each trait per species
trait_dat_mean <- trait_dat %>%
  group_by(vect_sp_codes, try_species_id, trait_name) %>%
  summarise(trait_mean = mean(value))
write.csv(trait_dat_mean, "trait_dat_mean.csv")


```


### add trait data 
```{r}
### open data
dat_trait <- read.csv("our_data/functional_diversity/trait_dat_mean.csv")

### simplify data
dat_trait_simp <- dat_trait %>%
  dplyr::select(vect_sp_codes,
                trait_name,
                trait_mean)

### fix repeated values due to NA try species id
dat_trait_simp <- dat_trait_simp %>%
  group_by(vect_sp_codes, trait_name) %>%
  summarise(trait_mean = mean(trait_mean))

### write trait data into matrix form
trait_wide <- dat_trait_simp %>%
  pivot_wider(names_from = trait_name,
              values_from = trait_mean)

### save trait data before alterations
write.csv(trait_wide, "trait_wide.csv")

### filter out LARI LAR because there is no trait data
trait_wide <- trait_wide %>%
  filter(!vect_sp_codes == "LARI LAR")

### save trait data as csv
write.csv(trait_wide, "trait_matrix.csv")

### merge with t1 data
t1_traits_dat <- merge(x = wcan_t1, 
                       y = trait_wide,
                       by.x = "NFI_species",
                       by.y = "vect_sp_codes",
                       all.x = TRUE)
t1_traits_dat$...1 <- NULL

### save t1 and traits as csv
write.csv(t1_traits_dat, "t1_traits_dat.csv")

```


### forms site-species matrix (reshape data)
```{r}
### create the matrix so that the rows are nfi plots and the columns are species, with values identifying biomass composition within each plot per species
t1_site_dat <- read.csv("our_data/functional_diversity/wcan_t1.csv")

t1_site_simp <- t1_site_dat %>%
  dplyr::select(nfi_plot,
                NFI_species,
                biomass_composition)

### filter out LARI LAR because there is no trait data
t1_site_simp <- t1_site_simp %>%
  filter(!NFI_species == "LARI LAR")
### filter out ACER SPI because there it is not present
t1_site_simp <- t1_site_simp %>%
  filter(!NFI_species == "ACER SPI")

t1_site_wide <- t1_site_simp %>%
  pivot_wider(names_from = NFI_species,
              values_from = biomass_composition)


### change NA <- 0
t1_site_wide[is.na(t1_site_wide)] <- 0

### which sites have no species
t1_site_no <- t1_site_wide %>%
  mutate(rowSums(t1_site_wide[, c(2:50)]))

rowSums(t1_site_no[, c(2:50)])

### save as csv
write.csv(t1_site_wide, "t1_site_matrix.csv")

```

### format datasets so that each matrix has the same set of species, names, and order
```{r}
### filter out sites without trees (biomass = 0)
no_biomass <- c("1039166", "1101001", "1101411", "1128496", "1142211", "1231676", "1280191", "1362476", "1396931")
site_fd <- t1_site_wide %>%
  filter(!nfi_plot %in% no_biomass) %>%
  column_to_rownames(var = "nfi_plot")
site_fd <- site_fd[, c(colnames(t1_site_wide) %in% trait_wide$vect_sp_codes)]
                              
site_fd <- site_fd[,order(colnames(site_fd))]


### list of species in matrix
species <- colnames(site_fd)

trait_fd <- trait_wide %>%
  filter(vect_sp_codes %in% species)
trait_fd <- trait_fd[order(trait_fd$vect_sp_codes), ]
trait_fd <- trait_fd %>% remove_rownames %>%
  column_to_rownames(var = "vect_sp_codes")
trait_fd[is.na(trait_fd)] <- 0

```

### recheck which plots have 0 trees
```{r}
### figure out which plot has no trees
site_check <- site_fd 
site_check <- site_check %>%
  rowid_to_column()
site_check$sum_trees <- rowSums(site_check) - site_check$rowid 
site_check <- site_check %>%
  filter(sum_trees < 1)
# rowid: 204, 371, 381, 383, 393
drop <- c("204", "371", "381", "383", "393")
site_fd[!(row.names(site_fd) %in% drop), ]

### check again
site_fd <- site_fd %>% 
  filter_all(any_vars(. != 0))
site_fd$...1 <- NULL


### save trait and site data as csv
write.csv(site_fd, "t1_site_fd.csv")
write.csv(trait_fd, "t1_trait_fd.csv")
```

### calculating functional diversity (t1)
```{r}
### drop extra column
t1_site_fd <- read.csv("our_data/functional_diversity/t1_site_fd.csv")
t1_site_fd$X <- NULL

t1_trait_fd <- read.csv("our_data/functional_diversity/t1_trait_fd.csv")

### make species row name
t1_trait_fd <- t1_trait_fd %>% column_to_rownames(var = "X")

### syntax: dbFD(trait_matrix, species_matrix, corr = c("corr_method"))
FD_calc <- dbFD(t1_trait_fd, 
                t1_site_fd,
                
                ### add calculations
                calc.FRic = TRUE,
                calc.FDiv = TRUE,
                calc.CWM = TRUE,
                
                ## weight by sp abund
                w.abun = TRUE,
                
                ## correction for distance matrix
                corr = "cailliez") 

### warning from input
#Warning in is.euclid(x.dist) : Zero distance(s)
#Warning in is.euclid(x.dist) : Zero distance(s)
#FEVe: Could not be calculated for communities with <3 functionally singular species. 
#FDis: Equals 0 in communities with only one functionally singular species. 
#FRic: To respect s > t, FRic could not be calculated for communities with <3 functionally singular species. 
#FRic: Dimensionality reduction was required. The last 29 PCoA axes (out of 31 in total) were removed. 
#Warning in is.euclid(x.dist) : Zero distance(s)
#FRic: Quality of the reduced-space representation = 0.3432491 
#Warning in is.euclid(x.dist) : Zero distance(s)
#Warning in is.euclid(x.dist) : Zero distance(s)
#FDiv: Could not be calculated for communities with <3 functionally singular species. 

### Extract outputs to datafram

### extract evenness to dataframe
feven_t1 <- as.data.frame(FD_calc[["FEve"]]) 

### extract diversity to dataframe
fdiv_t1 <- as.data.frame(FD_calc[["FDiv"]]) 

### extract richness to dataframe
fric_t1 <- as.data.frame(FD_calc[["FRic"]]) 

### extract community weighted means to dataframe
fcwm_t1 <- as.data.frame(FD_calc[["CWM"]])

# ### extract Rao's Q to dataframe
frao_t1 <- as.data.frame(FD_calc[["RQao"]]) 

# ### extract functional group richness to dataframe
fgr_t1 <- as.data.frame(FD_calc[["FGR"]]) 

### extract dissimilarity to dataframe
fdis_t1 <- as.data.frame(FD_calc[["FDis"]])

### Combine outputs into single data table
df_list <- c(feven_t1, fdiv_t1, fric_t1, fdis_t1, fcwm_t1)
fd_metrics <- as.data.table(df_list)

### combine into single table
fd_metrics <- fd_metrics %>% 
  #remove_rownames %>% 
  #column_to_rownames(var = "Row.names") %>%
  rename('fdiv' = "FD_calc[[\"FDiv\"]]",
         'feven' = "FD_calc[[\"FEve\"]]",
         'fric' = "FD_calc[[\"FRic\"]]",
         'fdis' = "FD_calc[[\"FDis\"]]")
#fd_metrics$plot_state <- row.names(fdis)

write_csv(fd_metrics, "t1_fd_metrics.csv")

### CWM
fcwm_t1 <- fcwm_t1 %>%
  rownames_to_column()

write_csv(fcwm_t1, "t1_cwm.csv")

```

### t2 plots
```{r}
### make df for t2 plots
wcan_t2 <- wcan_dat %>%
  filter(time_step == "t2")

wcan_t2 <- wcan_t2 %>%
  dplyr::select(nfi_plot,
                meas_date,
                NFI_species,
                time_step,
                biomass_composition,
                meas_year)

### total biomass per plot
plot_biomass_tot_t2 <- wcan_t2 %>%
  group_by(nfi_plot, meas_date) %>%
  summarise(total_biomass_plot = sum(biomass_composition))

### merge 
wcan_t2 <- merge(wcan_t2, plot_biomass_tot_t2,
                 by = c("nfi_plot", "meas_date"))

### percent biomass (per plot)
wcan_t2 <- wcan_t2 %>%
  mutate(pct_biomass = biomass_composition/total_biomass_plot)

### save as csv
write.csv(wcan_t2, "wcan_t2.csv")

```

### add traits
```{r}
### open trait data 
trait_wide_t2 <- read.csv("our_data/functional_diversity/trait_wide.csv")

### merge with t2 data
t2_traits_dat <- merge(x = wcan_t2, 
                       y = trait_wide_t2,
                       by.x = "NFI_species",
                       by.y = "vect_sp_codes",
                       all.x = TRUE)


### save t2 and traits as csv
write.csv(t2_traits_dat, "t2_traits_dat.csv")


```

### forms site-species matrix (reshape data)
```{r}
### create the matrix so that the rows are nfi plots and the columns are species, with values identifying biomass composition within each plot per species
t2_site_dat <- read.csv("our_data/functional_diversity/wcan_t2.csv")

t2_site_simp <- t2_site_dat %>%
  dplyr::select(nfi_plot,
                NFI_species,
                biomass_composition)

t2_site_wide <- t2_site_simp %>%
  pivot_wider(names_from = NFI_species,
              values_from = biomass_composition)

### change NA <- 0
t2_site_wide[is.na(t2_site_wide)] <- 0

### save as csv
write.csv(t2_site_wide, "t2_site_matrix.csv")

### format datasets so each matrix has the same species and order
t2_site_fd <- t2_site_wide[, c(colnames(t2_site_wide) %in% trait_wide$vect_sp_codes)]
t2_site_fd <- t2_site_fd[,order(colnames(t2_site_fd))]


### list of species in matrix
species <- colnames(t2_site_fd)

t2_trait_fd <- trait_wide_t2 %>%
  filter(vect_sp_codes %in% species)
t2_trait_fd <- t2_trait_fd[order(t2_trait_fd$vect_sp_codes), ]
t2_trait_fd <- t2_trait_fd %>% remove_rownames %>%
  column_to_rownames(var = "vect_sp_codes")
t2_trait_fd[is.na(t2_trait_fd)] <- 0

### figure out which plot has no trees
t2_site_check <- t2_site_fd 
t2_site_check <- t2_site_check %>%
  rowid_to_column()
t2_site_check$sum_trees <- rowSums(t2_site_check) - t2_site_check$rowid 
t2_site_fd <- t2_site_check %>%
  filter(sum_trees > 1)

### check again
t2_site_fd <- t2_site_fd %>% 
  filter_all(any_vars(. != 0))


### save trait and site data as csv
t2_trait_fd <- write.csv(t2_trait_fd, "t2_trait_fd.csv")
t2_site_fd <- write.csv(t2_site_fd, "t2_site_fd.csv")

```

### calculating functional diversity (t2)
```{r}
### remove additional site columns
t2_site_fd$rowid <- NULL
t2_site_fd$...1 <- NULL
t2_site_fd$sum_trees <- NULL

### change col to rownames
t2_trait_fd <- t2_trait_fd %>% column_to_rownames(var = "...1")
t2_trait_fd$X <- NULL

### syntax: dbFD(trait_matrix, species_matrix, corr = c("corr_method"))
FD_calc_t2 <- dbFD(t2_trait_fd, 
                t2_site_fd,
                
                ### add calculations
                calc.FRic = TRUE,
                calc.FDiv = TRUE,
                calc.CWM = TRUE,
                
                ## weight by sp abund
                w.abun = TRUE,
                
                ## correction for distance matrix
                corr = "cailliez") 

#Warning in is.euclid(x.dist) : Zero distance(s)
#Warning in is.euclid(x.dist) : Zero distance(s)
#FEVe: Could not be calculated for communities with <3 functionally singular species. 
#FDis: Equals 0 in communities with only one functionally singular species. 
#FRic: To respect s > t, FRic could not be calculated for communities with <3 functionally singular species. 
#FRic: Dimensionality reduction was required. The last 9 PCoA axes (out of 11 in total) were removed. 
#Warning in is.euclid(x.dist) : Zero distance(s)
#FRic: Quality of the reduced-space representation = 0.5738699 
#Warning in is.euclid(x.dist) : Zero distance(s)
#Warning in is.euclid(x.dist) : Zero distance(s)
#FDiv: Could not be calculated for communities with <3 functionally singular species. 

### Extract outputs to datafram

### extract evenness to dataframe
feven_t2 <- as.data.frame(FD_calc_t2[["FEve"]]) 

### extract diversity to dataframe
fdiv_t2 <- as.data.frame(FD_calc_t2[["FDiv"]]) 

### extract richness to dataframe
fric_t2 <- as.data.frame(FD_calc_t2[["FRic"]]) 

### extract community weighted means to dataframe
fcwm_t2 <- as.data.frame(FD_calc_t2[["CWM"]])

# ### extract Rao's Q to dataframe
frao_t2 <- as.data.frame(FD_calc_t2[["RQao"]]) 

# ### extract functional group richness to dataframe
fgr_t2 <- as.data.frame(FD_calc_t2[["FGR"]]) 

### extract dissimilarity to dataframe
fdis_t2 <- as.data.frame(FD_calc_t2[["FDis"]])

### Combine outputs into single data table
df_list <- c(feven_t2, fdiv_t2, fric_t2, fdis_t2, fcwm_t2)
fd_metrics_t2 <- as.data.table(df_list)

### combine into single table
fd_metrics_t2 <- fd_metrics_t2 %>% 
  #remove_rownames %>% 
  #column_to_rownames(var = "Row.names") %>%
  rename('fdiv' = "FD_calc_t2[[\"FDiv\"]]",
         'feven' = "FD_calc_t2[[\"FEve\"]]",
         'fric' = "FD_calc_t2[[\"FRic\"]]",
         'fdis' = "FD_calc_t2[[\"FDis\"]]")
#fd_metrics$plot_state <- row.names(fdis)

write_csv(fd_metrics_t2, "t2_fd_metrics.csv")

### CWM
fcwm_t2 <- fcwm_t2 %>%
  rownames_to_column()

write_csv(fcwm_t2, "t2_cwm.csv")
```

### CWM trends over time
```{r}
### open cwm files for t1 & t2
cwm_t1 <- read.csv("our_data/functional_diversity/t1_cwm.csv") %>%
  mutate(time_step = "t1")
cwm_t2 <- read.csv("our_data/functional_diversity/t2_cwm.csv") %>%
  mutate(time_step = "t2")

### rbind files
tot_cwm <- rbind(cwm_t1, cwm_t2)

### rename traits
tot_cwm <- tot_cwm %>%
  dplyr::select(bark_thickness = bark.thickness,
                bud_burst_mean = bud.burst.timing..mean.month.,
                clonal_growth_form = clonal.growth.form,
                coarse_root_depth = coarse.root.rooting.depth,
                cold_tolerance,
                cone_serotiny = cone.serotiny,
                dispersal_distance = dispersal.distance,
                dispersal_syndrome = dispersal.syndrome,
                drought_tolerance,
                bud_burst_early = earliest.bud.burst.timing..month.,
                fire_resistance,
                fire_tolerance,
                foliage = foliage.type..deciduous.or.evergreen.,
                bud_burst_late = latest.bud.burst.timing..month.,
                leaf_dry_matter_content = leaf.dry.matter.content,
                leaf_flammability = leaf.flammability,
                leaf_force_punch = leaf.force.to.punch,
                leaf_photosyn_rate = leaf.photosynthetic.rate,
                leaf_text_coarse = leaf.texture..coarseness.,
                leaf_thickness = leaf.thickness,
                leaf_length,
                max_height = maximum.height,
                plant_height_veg = plant.height..vegetative,
                resprout_ability = resprouting.ability,
                shade_tolerance,
                specific_leaf_area = specific.leaf.area,
                waterlogging_tolerance,
                wood_density = wood..or.stem.specific..density,
                 water_potential_50_loss_stem = water.potential.at.50..loss.of.stem.hydraulic.conductivity,
                xylem_conductance = xylem.conductance,
                low_branch_height = height.of.lowest.branch,
                hydraulic_safety_margin_50 = hydraulic.safety.margin.50.,
                hydraulic_safety_margin_88 = hydraulic.safety.margin.88.,
                leaf_mass_area = leaf.mass.area,
                min_midday_xylem = minimum.midday.xylem.pressure.potential,
                seed_bank_longevity = seed.bank.longevity,
                slope_vulnerability_curve = slope.of.vulnerability.curve,
                stem_conduit_diam = stem.conduit.diameter..vessels.and.tracheids.,
                water_potential_12_loss_stem = water.potential.at.12..loss.of.stem.hydraulic.conductivity,
                water_potential_88_loss_stem = water.potential.at.88..loss.of.stem.hydraulic.conductivity,
                deg_self_pruning = degree.of.self.pruning,
                photosynth_water_effic = photosynthetic.water.use.efficiency,
                specific_leaf_conduct = specific.leaf.conductivity,
                stem_conduit_dens = stem.conduit.density..vessels.and.tracheids.,
                stomatal_conductance = stomatal.conductance,
                seedbank_duration = seedbank.duration,
                leaf_toughness = leaf.toughness,
                min_predawn_xylem = minimum.predawn.xylem.pressure.potential,
                stem_xylem_vulnerability_p50 = stem.xylem.embolism.vulnerability..P50,
                leaf_texture = Leaf.texture..sclerophylly..physical.strength..toughness.,
                photosyn_rate_per_leaf_area = Photosynthesis.rate.per.leaf.area,
                plant_height_gen = Plant.height.generative,
                leaf_water_content = leaf.water.content,
                seedbank_density = seedbank.density,
                stomata_density = stomata.density,
                relative_growth_rate = relative.growth.rate,
                water_use_effic = intrinsic.water.use.efficiency,
                time_step)

### write as csv
write_csv(tot_cwm, "cwm_total.csv")

### make cwm long
long_cwm <- tot_cwm %>%
  pivot_longer(cols = bark_thickness:water_use_effic)

### change NA <- 0
long_cwm[is.na(long_cwm)] <- 0

### get trait means
cwm_summ <- long_cwm %>%
  group_by(time_step, name) %>%
  summarise(mean_trait_val = mean(value,
                                  na.rm = TRUE),
            sd_trait_val = sd(value,
                              na.rm = TRUE))
### write as csv
write_csv(cwm_summ, "cwm_mean_trait_values.csv")

### time steps
cwm_summ$time_step <- as.factor(cwm_summ$time_step)

### visualize bud burst
cwm_bud_burst <- cwm_summ %>%
  filter(name %in% c("bud_burst_mean",
                      "bud_burst_early",
                      "bud_burst_late")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("Bud burst timing (month)") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_bbt_time.png",
       width = 10, height = 7)

### visualize bark & leaf thickness
cwm_bud_burst <- cwm_summ %>%
  filter(name %in% c("bark_thickness",
                     "leaf_thickness")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("Mean bark thickness (mm)") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_thick_time.png",
       width = 10, height = 7)

### visualize plant height gen, veg
cwm_plant_height <- cwm_summ %>%
  filter(name %in% c("plant_height_veg",
                     "plant_height_gen",
                     "low_branch_height",
                     "max_height")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("Plant height (m)") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_plant_height_time.png",
       width = 10, height = 7)

### visualize leaf length
cwm_leaf_length <- cwm_summ %>%
  filter(name %in% c("leaf_length")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("Leaf length") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_leaf_length_time.png",
       width = 10, height = 7)

### visualize water loss & safety margin
cwm_MPa <- cwm_summ %>%
  filter(name %in% c("water_potential_50_loss_stem",
                     "water_potential_88_loss_stem",
                     "water_potential_12_loss_stem",
                     "hydraulic_safety_margin_50",
                     "hydraulic_safety_margin_88",
                     "stem_xylem_vulnerability_p50")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("MPa") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_MPa_time.png",
       width = 10, height = 7)

 ### visualize photosynthesis
cwm_photosyn <- cwm_summ %>%
  filter(name %in% c("photosyn_rate_per_leaf_area",
                     "leaf_photosyn_rate")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("micromol/m2/s") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_photosyn_time.png",
       width = 10, height = 7)

### visualize seedbank
cwm_seedbank <- cwm_summ %>%
  filter(name %in% c("seedbank_density",
                     "seedbank_duration")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("years") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_seedbank_time.png",
       width = 10, height = 7)

### visualize density - stem conduit & stomata
cwm_dens <- cwm_summ %>%
  filter(name %in% c("stem_conduit_dens",
                    "stomata_density")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("per mm2") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_per_mm2_time.png",
       width = 10, height = 7)

### visualize xylem conductance
cwm_xy_cond <- cwm_summ %>%
  filter(name %in% c("xylem_conductance")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("(mu)1 hr-I mm- 2") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_xylem_conductance.png",
       width = 10, height = 7)

### visualize leaf dry matter
cwm_leaf_dry <- cwm_summ %>%
  filter(name %in% c("leaf_dry_matter_content")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("g/g") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_leaf_dry.png",
       width = 10, height = 7)

### visualize relative growth rate
cwm_rgr <- cwm_summ %>%
  filter(name %in% c("relative_growth_rate")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("g/g/d") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_rgr.png",
       width = 10, height = 7)

### visualize leaf mass area
cwm_lma <- cwm_summ %>%
  filter(name %in% c("leaf_mass_area")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("g/m2") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_leaf_m_a.png",
       width = 10, height = 7)

### visualize leaf water content
cwm_lwc <- cwm_summ %>%
  filter(name %in% c("leaf_water_content")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("gr H2O / FW*100") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_leaf_water_cont.png",
       width = 10, height = 7)

### visualize leaf toughness
cwm_leaf_tough <- cwm_summ %>%
  filter(name %in% c("leaf_toughness")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("kg") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_leaf_tough.png",
       width = 10, height = 7)

### visualize leaf conductivity
cwm_l_cond <- cwm_summ %>%
  filter(name %in% c("specific_leaf_conduct")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("kg/m/s/MPa") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_leaf_conduct.png",
       width = 10, height = 7)

### visualize wood density
cwm_wood_dens <- cwm_summ %>%
  filter(name %in% c("wood_density")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("kg/m3") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_wood_dens.png",
       width = 10, height = 7)

### visualize dispersal distance
cwm_disp_dist <- cwm_summ %>%
  filter(name %in% c("dispersal_distance")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("m") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_dispers_dist.png",
       width = 10, height = 7)

### visualize stem conduit diameter
cwm_stem_cond_diam <- cwm_summ %>%
  filter(name %in% c("stem_conduit_diam")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("microm") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_stem_conduit_diam.png",
       width = 10, height = 7)

### visualize water use efficiency
cwm_water_effic <- cwm_summ %>%
  filter(name %in% c("water_use_effic")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("micromol/mol") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_water_effic.png",
       width = 10, height = 7)

### visualize SLA
cwm_sla <- cwm_summ %>%
  filter(name %in% c("specific_leaf_area")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("mm2/mg") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_sla.png",
       width = 10, height = 7)

### visualize stomatal conductance
cwm_stom_conduc <- cwm_summ %>%
  filter(name %in% c("stomatal_conductance")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("mmol/m2/s") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_stom_conduc.png",
       width = 10, height = 7)

### visualize xylem pressure potential
cwm_xylem_press_pot <- cwm_summ %>%
  filter(name %in% c("min_midday_xylem",
                     "min_predawn_xylem")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("MPa") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_xylem_press_pot.png",
       width = 10, height = 7)

### visualize leaf force to punch
cwm_punch <- cwm_summ %>%
  filter(name %in% c("leaf_force_punch")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("N/mm2") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_leaf_force_punch.png",
       width = 10, height = 7)

### visualize seedbank density
cwm_seedb_dens <- cwm_summ %>%
  filter(name %in% c("seedbank_density")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("seeds/acre") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_seedbank_dens.png",
       width = 10, height = 7)

### visualize foliage type
cwm_foliage <- cwm_summ %>%
  filter(name %in% c("foliage")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("foliage type") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_foliage.png",
       width = 10, height = 7)

### visualize cone serotiny
cwm_cone_serot <- cwm_summ %>%
  filter(name %in% c("cone_serotiny")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("serotiny type") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_cone_serot.png",
       width = 10, height = 7)

### visualize photosynthetic water use efficiency
cwm_phot_water_effic <- cwm_summ %>%
  filter(name %in% c("photosynth_water_effic")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("umol/mmol") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_photosyn_water_effic.png",
       width = 10, height = 7)

### visualize dispersal syndrome
cwm_disp_syndrome <- cwm_summ %>%
  filter(name %in% c("dispersal_syndrome")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("dispersal vector") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_disp_syndrome.png",
       width = 10, height = 7)

### visualize coarse rooting depth
cwm_root_depth <- cwm_summ %>%
  filter(name %in% c("coarse_root_depth")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("rooting depth") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_coarse_root_depth.png",
       width = 10, height = 7)

### visualize cone serotiny
cwm_cone_serotiny <- cwm_summ %>%
  filter(name %in% c("cone_serotiny")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("serotiny type") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_cone_serotiny.png",
       width = 10, height = 7)

### visualize cold tolerance
cwm_cold_tol <- cwm_summ %>%
  filter(name %in% c("cold_tolerance")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val),
             size = 3) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("tolerance") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_cold_tolerance.png",
       width = 10, height = 7)

### visualize fire tolerance
cwm_fire_tol <- cwm_summ %>%
  filter(name %in% c("fire_tolerance")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val),
             size = 3) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("tolerance") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_fire_tolerance.png",
       width = 10, height = 7)

### visualize leaf texture (coarseness)
cwm_leaf_text <- cwm_summ %>%
  filter(name %in% c("leaf_text_coarse")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("texture") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_leaf_texture_coarse.png",
       width = 10, height = 7)

### visualize fire resistance
cwm_fire_resist <- cwm_summ %>%
  filter(name %in% c("fire_resistance")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val),
             size = 3) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("resistance") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_fire_resistance.png",
       width = 10, height = 7)

### visualize leaf flammability
cwm_leaf_flamm <- cwm_summ %>%
  filter(name %in% c("leaf_flammability")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("flammability") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_leaf_flamm.png",
       width = 10, height = 7)

### visualize resprouting ability
cwm_resprout <- cwm_summ %>%
  filter(name %in% c("resprout_ability")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("resprouting ability") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_resprout.png",
       width = 10, height = 7)

### visualize clonal growth form
cwm_clonal_growth <- cwm_summ %>%
  filter(name %in% c("clonal_growth_form")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("clonal growth form") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_clonal growth.png",
       width = 10, height = 7)

### visualize shade tolerance
cwm_shade_tol <- cwm_summ %>%
  filter(name %in% c("shade_tolerance")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("shade tolerance") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_shade_tol.png",
       width = 10, height = 7)

### visualize water logging tolerance
cwm_water_log_tol <- cwm_summ %>%
  filter(name %in% c("waterlogging_tolerance")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("waterlogging tolerance") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_waterlog_tol.png",
       width = 10, height = 7)

### visualize drought tolerance
cwm_drought_tol <- cwm_summ %>%
  filter(name %in% c("drought_tolerance")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val),
             size = 3) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("drought_tolerance") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_drought_tol.png",
       width = 10, height = 7)

### visualize degree of self-pruning
cwm_self_pruning <- cwm_summ %>%
  filter(name %in% c("deg_self_pruning")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val)) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("degree of self pruning") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_self_pruning.png",
       width = 10, height = 7)

### visualize leaf texture ... toughness
cwm_leaf_text <- cwm_summ %>%
  filter(name %in% c("leaf_texture")) %>%
  ggplot() +
  geom_point(aes(x = time_step,
                 y = mean_trait_val),
             size = 3) +
  geom_errorbar(aes(x = time_step,
                    ymin = mean_trait_val - sd_trait_val,
                    ymax = mean_trait_val + sd_trait_val),
                width = 0.1) +
  xlab("Time step") +
  ylab("leaf texture") +
  facet_wrap(~name,
             scales = "free")

ggsave("cwm_leaf_texture.png",
       width = 10, height = 7)


```

### find trait units
```{r}
trait_unit <- read.csv("our_data/nfi_trait_dat_clean_sp.csv")

trait_unit <- trait_unit %>%
  dplyr::select(trait_name, unit) %>%
  distinct()
trait_unit <- trait_unit %>%
  duplicated(trait_unit)
```

